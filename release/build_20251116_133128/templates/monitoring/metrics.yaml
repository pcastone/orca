# Metrics Collection Configuration
# Defines what metrics to collect for monitoring and performance analysis

metrics:
  # Task Plan Metrics
  plan_metrics:
    - name: "plan_generation_time_ms"
      type: "histogram"
      description: "Time taken to generate task plan"
      unit: "milliseconds"
      buckets: [100, 500, 1000, 5000, 10000, 30000]

    - name: "plan_validation_time_ms"
      type: "histogram"
      description: "Time to validate task plan"
      unit: "milliseconds"
      buckets: [10, 50, 100, 500, 1000]

    - name: "plan_tasks_count"
      type: "histogram"
      description: "Number of tasks in generated plan"
      buckets: [1, 3, 5, 7, 10, 15, 20]

    - name: "plan_complexity_score"
      type: "gauge"
      description: "Calculated plan complexity (0.0-1.0)"
      min: 0.0
      max: 1.0

  # Task Execution Metrics
  task_metrics:
    - name: "task_execution_time_ms"
      type: "histogram"
      description: "Time to execute single task"
      unit: "milliseconds"
      buckets: [100, 500, 1000, 5000, 10000, 30000, 60000]

    - name: "task_success_rate"
      type: "counter"
      description: "Ratio of successful vs failed tasks"
      labels: ["workflow_id", "task_action"]

    - name: "task_retry_count"
      type: "counter"
      description: "Number of task retry attempts"
      labels: ["workflow_id", "error_type"]

    - name: "tasks_per_plan"
      type: "histogram"
      description: "Tasks completed per plan"
      buckets: [1, 3, 5, 7, 10, 15]

  # Tool Execution Metrics
  tool_metrics:
    - name: "tool_calls_total"
      type: "counter"
      description: "Total number of tool calls"
      labels: ["tool_name", "status"]

    - name: "tool_execution_time_ms"
      type: "histogram"
      description: "Tool execution time"
      unit: "milliseconds"
      buckets: [10, 50, 100, 500, 1000, 5000, 10000]
      labels: ["tool_name"]

    - name: "tool_success_rate"
      type: "gauge"
      description: "Success rate per tool"
      labels: ["tool_name"]

    - name: "tool_errors_by_type"
      type: "counter"
      description: "Tool errors categorized by type"
      labels: ["tool_name", "error_code"]

  # LLM Metrics
  llm_metrics:
    - name: "llm_call_time_ms"
      type: "histogram"
      description: "LLM API call latency"
      unit: "milliseconds"
      buckets: [100, 500, 1000, 2000, 5000, 10000, 30000]
      labels: ["model", "provider"]

    - name: "llm_tokens_used"
      type: "counter"
      description: "Total tokens consumed"
      labels: ["model", "type"]  # type: input, output

    - name: "llm_cost_per_task"
      type: "histogram"
      description: "Cost per task in USD"
      buckets: [0.001, 0.01, 0.05, 0.10, 0.50, 1.00, 5.00]

    - name: "llm_error_rate"
      type: "counter"
      description: "LLM API errors"
      labels: ["model", "error_type"]

  # System Metrics
  system_metrics:
    - name: "websocket_latency_ms"
      type: "histogram"
      description: "WebSocket round-trip latency"
      unit: "milliseconds"
      buckets: [1, 5, 10, 50, 100, 500, 1000]

    - name: "context_window_usage"
      type: "histogram"
      description: "Percentage of context window used"
      buckets: [10, 25, 50, 75, 90, 95, 100]

    - name: "memory_usage_mb"
      type: "gauge"
      description: "Process memory usage"
      unit: "megabytes"

    - name: "active_sessions"
      type: "gauge"
      description: "Number of active WebSocket sessions"

# Collection Settings
collection:
  interval_ms: 60000  # Collect every minute
  retention_days: 30  # Keep metrics for 30 days
  aggregation_window_ms: 300000  # 5-minute aggregation windows

# Export Settings
export:
  enabled: true
  format: "prometheus"  # or "json", "influxdb"
  endpoint: "/metrics"

  # Optional: Push to external system
  # push_gateway: "http://localhost:9091"
  # push_interval_ms: 60000

# Alerts (optional)
alerts:
  - name: "high_task_failure_rate"
    condition: "task_success_rate < 0.8"
    severity: "warning"
    description: "Task success rate below 80%"

  - name: "llm_cost_spike"
    condition: "llm_cost_per_task > 1.00"
    severity: "warning"
    description: "Task cost exceeds $1.00"

  - name: "slow_execution"
    condition: "task_execution_time_ms > 60000"
    severity: "info"
    description: "Task taking longer than 1 minute"

# Dashboards
dashboards:
  overview:
    - metric: "tasks_per_plan"
      visualization: "histogram"
    - metric: "task_success_rate"
      visualization: "gauge"
    - metric: "llm_tokens_used"
      visualization: "counter"

  performance:
    - metric: "task_execution_time_ms"
      visualization: "heatmap"
    - metric: "tool_execution_time_ms"
      visualization: "histogram"
    - metric: "llm_call_time_ms"
      visualization: "time_series"

  costs:
    - metric: "llm_cost_per_task"
      visualization: "bar_chart"
    - metric: "llm_tokens_used"
      visualization: "stacked_area"
