# Execution Tools Catalog
# Comprehensive catalog of shell and process execution tools

category: "execution"
description: "Tools for running shell commands, tests, and builds"

tools:
  # Shell Execution
  - name: "shell_exec"
    description: "Execute a shell command"
    parameters:
      - name: "cmd"
        type: "string"
        required: true
        description: "Command to execute"
      - name: "cwd"
        type: "string"
        required: false
        default: "."
        description: "Working directory"
      - name: "timeout_ms"
        type: "integer"
        required: false
        default: 600000  # 10 minutes
        description: "Timeout in milliseconds"
      - name: "env"
        type: "object"
        required: false
        description: "Environment variables"
    returns:
      type: "object"
      properties:
        stdout:
          type: "string"
          description: "Standard output"
        stderr:
          type: "string"
          description: "Standard error"
        exit_code:
          type: "integer"
          description: "Exit code (0 = success)"
        duration_ms:
          type: "integer"
          description: "Execution time"
    errors:
      - code: "E_COMMAND_NOT_FOUND"
      - code: "E_TIMEOUT"
      - code: "E_PERMISSION_DENIED"
      - code: "E_COMMAND_BLOCKED"
    security:
      allowlist_required: true
      audit_log: true
    example:
      input: { cmd: "cargo test", timeout_ms: 300000 }
      output: { stdout: "running 5 tests...", stderr: "", exit_code: 0, duration_ms: 1234 }

  # Process List
  - name: "proc_list"
    description: "List running processes"
    parameters:
      - name: "filter"
        type: "string"
        required: false
        description: "Filter by process name"
      - name: "limit"
        type: "integer"
        required: false
        default: 50
        description: "Maximum processes to return"
    returns:
      type: "object"
      properties:
        processes:
          type: "array"
          items:
            type: "object"
            properties:
              pid:
                type: "integer"
              name:
                type: "string"
              cpu_percent:
                type: "number"
              memory_mb:
                type: "integer"
        count:
          type: "integer"
    example:
      input: { filter: "rust", limit: 10 }
      output: { processes: [{pid: 1234, name: "cargo", cpu_percent: 15.3, memory_mb: 256}], count: 1 }

# Common Command Patterns
common_commands:
  # Rust/Cargo
  rust:
    - name: "cargo build"
      description: "Build Rust project"
      timeout_ms: 300000  # 5 minutes
      example: "cargo build --release"

    - name: "cargo test"
      description: "Run Rust tests"
      timeout_ms: 600000  # 10 minutes
      example: "cargo test --all-features"

    - name: "cargo check"
      description: "Quick compile check"
      timeout_ms: 120000  # 2 minutes
      example: "cargo check"

    - name: "cargo clippy"
      description: "Run linter"
      timeout_ms: 180000  # 3 minutes
      example: "cargo clippy -- -D warnings"

    - name: "cargo fmt"
      description: "Format code"
      timeout_ms: 60000  # 1 minute
      example: "cargo fmt --check"

  # Node/NPM
  nodejs:
    - name: "npm install"
      description: "Install dependencies"
      timeout_ms: 300000
      example: "npm install"

    - name: "npm test"
      description: "Run tests"
      timeout_ms: 300000
      example: "npm test"

    - name: "npm run build"
      description: "Build project"
      timeout_ms: 300000
      example: "npm run build"

    - name: "npm run lint"
      description: "Run linter"
      timeout_ms: 120000
      example: "npm run lint"

  # Python
  python:
    - name: "pytest"
      description: "Run Python tests"
      timeout_ms: 300000
      example: "python -m pytest"

    - name: "pip install"
      description: "Install packages"
      timeout_ms: 300000
      example: "pip install -r requirements.txt"

    - name: "black"
      description: "Format Python code"
      timeout_ms: 60000
      example: "python -m black ."

    - name: "mypy"
      description: "Type checking"
      timeout_ms: 120000
      example: "python -m mypy ."

# Security Allowlist
# Only commands matching these patterns are allowed
allowlist:
  rust:
    - "^cargo\\s+(build|test|check|clippy|fmt|doc|run|bench)"
    - "^rustc\\s+"
    - "^rustfmt\\s+"

  nodejs:
    - "^npm\\s+(install|test|run|start|build)"
    - "^yarn\\s+(install|test|run|start|build)"
    - "^node\\s+"

  python:
    - "^python3?\\s+"
    - "^pip3?\\s+(install|list|show)"
    - "^pytest\\s+"

  git:
    - "^git\\s+(status|diff|log|show|branch)"

  utilities:
    - "^ls\\s+"
    - "^cat\\s+"
    - "^grep\\s+"
    - "^find\\s+"
    - "^rg\\s+"  # ripgrep
    - "^echo\\s+"
    - "^pwd$"
    - "^which\\s+"

# Security Denylist
# Block dangerous commands even if they match allowlist
denylist:
  - "rm\\s+-rf\\s+/"  # Prevent root deletion
  - "dd\\s+if="  # Prevent disk operations
  - "mkfs"  # Prevent filesystem formatting
  - "fdisk"  # Prevent partition operations
  - "sudo"  # No privilege escalation
  - "su\\s+"  # No user switching
  - "chmod\\s+777"  # Prevent overly permissive permissions
  - "\\|\\s*sh"  # Prevent pipe to shell
  - "curl.*\\|.*sh"  # Prevent curl-to-shell
  - "wget.*\\|.*sh"  # Prevent wget-to-shell

# Performance Guidelines
performance:
  shell_exec:
    default_timeout: 600000  # 10 minutes
    max_timeout: 1800000  # 30 minutes
    max_concurrent: 3

  proc_list:
    timeout_ms: 5000
    max_results: 100

# Best Practices
best_practices:
  - "Always specify timeout for long-running commands"
  - "Use cargo check instead of cargo build for faster feedback"
  - "Run tests before commits"
  - "Use --release for production builds"
  - "Capture both stdout and stderr"
  - "Check exit code to determine success"
  - "Use specific commands rather than shell scripts"
  - "Avoid commands with side effects when possible"

# Error Handling
error_handling:
  non_zero_exit:
    - "Check stderr for error messages"
    - "Examine stdout for partial output"
    - "Retry with verbose flags if needed"

  timeout:
    - "Increase timeout_ms parameter"
    - "Break command into smaller steps"
    - "Check for infinite loops or hangs"

  command_blocked:
    - "Verify command matches allowlist pattern"
    - "Check workspace configuration"
    - "Use alternative approved command"

# Common Workflows
workflows:
  test_workflow:
    - description: "Run full test suite"
      steps:
        - { cmd: "cargo check" }
        - { cmd: "cargo clippy" }
        - { cmd: "cargo test" }

  build_workflow:
    - description: "Build release binary"
      steps:
        - { cmd: "cargo clean" }
        - { cmd: "cargo build --release" }
        - { cmd: "cargo test --release" }

  pre_commit:
    - description: "Pre-commit checks"
      steps:
        - { cmd: "cargo fmt --check" }
        - { cmd: "cargo clippy -- -D warnings" }
        - { cmd: "cargo test" }

# Timeout Recommendations
timeout_recommendations:
  quick_check: 60000  # 1 minute (cargo check, fmt)
  linting: 120000  # 2 minutes (clippy, eslint)
  unit_tests: 300000  # 5 minutes (cargo test, npm test)
  integration_tests: 600000  # 10 minutes (full test suite)
  builds: 300000  # 5 minutes (cargo build)
  release_builds: 600000  # 10 minutes (cargo build --release)

# Exit Code Meanings
exit_codes:
  0: "Success"
  1: "General error"
  2: "Misuse of shell command"
  126: "Command cannot execute"
  127: "Command not found"
  128: "Invalid exit argument"
  130: "Terminated by Ctrl+C"
  137: "Killed (SIGKILL)"
  143: "Terminated (SIGTERM)"
