# Task Breakdown and Planning Workflow
# Pattern: Plan-Execute (Explicit Planning)
# Purpose: Break down complex tasks into manageable, executable steps
#
# This workflow uses the Plan-Execute pattern which separates planning from
# execution. The planner LLM creates an explicit step-by-step plan, then the
# executor LLM carries out each step. This enables better handling of complex,
# multi-step tasks that require upfront coordination.
#
# Use Cases:
# - Research projects requiring multiple information gathering steps
# - Complex refactoring tasks
# - Multi-file code changes with dependencies
# - Data analysis pipelines
# - Feature implementation with multiple components
# - Investigation requiring systematic exploration
#
# Tools Available:
# - All tools: file_read, file_write, grep, shell_exec, git_status, git_diff
#
# How It Works:
# 1. Planner creates detailed step-by-step plan
# 2. Executor executes each step using tools
# 3. After each step, plan can be revised if needed (replanning)
# 4. Process continues until task is complete

id: "task_breakdown_planning"
description: "Break down complex tasks into manageable steps using Plan-Execute pattern"

steps:
  # Primary planning and execution step
  - name: "create_and_execute_plan"
    pattern: "plan_execute_1"
    config:
      # Maximum steps in the plan
      max_steps: 15

      # Enable replanning if circumstances change
      replanning_enabled: true

      # Planner LLM configuration
      planner_config:
        model: "gpt-4"
        temperature: 0.7  # Higher temperature for creative planning

      # Executor LLM configuration
      executor_config:
        model: "gpt-4"
        temperature: 0.5  # Lower temperature for accurate execution

      # All tools available for execution
      tools:
        - file_read
        - file_write
        - grep
        - shell_exec
        - git_status
        - git_diff
        - fs_list
        - file_patch

      # System prompt for planning and execution
      system_prompt: |
        You are a task planning and execution assistant using the Plan-Execute pattern.

        PLANNER MODE:
        When planning, you should:
        1. Understand the task requirements thoroughly
        2. Break down the task into clear, sequential steps
        3. Identify dependencies between steps
        4. Specify what tools each step will need
        5. Anticipate potential issues or edge cases
        6. Create a plan that is detailed but flexible

        A good plan has:
        - Clear, actionable steps (not vague instructions)
        - Logical ordering (dependencies resolved)
        - Specific success criteria for each step
        - Reasonable scope (not too granular, not too broad)
        - Contingency for errors

        EXECUTOR MODE:
        When executing steps, you should:
        1. Follow the plan step by step
        2. Use the appropriate tools for each step
        3. Verify results before moving to next step
        4. Report any issues that require replanning
        5. Track progress and remaining work

        REPLANNING:
        Trigger replanning when:
        - A step fails unexpectedly
        - New information changes the approach
        - A dependency is discovered
        - The original plan proves insufficient

        When replanning:
        - Preserve completed work
        - Adjust only what's necessary
        - Maintain the overall goal

        Remember:
        - Plans are living documents
        - Execution reveals new information
        - Adapt as needed while staying focused on the goal

    on_success:
      end: true

    on_failure:
      # If we've made significant progress, consider that partial success
      if: "steps_completed > 3"
      then:
        end: true
      else: "retry_with_simpler_plan"

  # Fallback: retry with a simpler, more focused plan
  - name: "retry_with_simpler_plan"
    pattern: "plan_execute_1"
    config:
      # Fewer steps for simpler plan
      max_steps: 8

      # Disable replanning to force focus
      replanning_enabled: false

      # Same tools available
      tools:
        - file_read
        - file_write
        - grep
        - shell_exec
        - git_status
        - git_diff

      system_prompt: |
        The initial plan was too ambitious or complex. Create a simpler,
        more focused plan that addresses the core requirements without
        trying to handle every edge case.

        Focus on:
        - Essential steps only
        - Simple, direct approach
        - Known, reliable techniques
        - Clear success criteria

    on_success:
      end: true

    on_failure:
      end: true

# Global workflow settings
settings:
  # Maximum total steps across all workflow stages
  max_total_steps: 25

  # Enable automatic retries
  enable_retries: true

  # Maximum retries per step
  max_retries: 1

  # Timeout for entire workflow (10 minutes)
  timeout: 600
