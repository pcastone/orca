{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow Execution State",
  "description": "Schema for tracking workflow and task execution state",
  "type": "object",
  "required": ["execution_id", "plan_id", "status", "created_at"],
  "properties": {
    "execution_id": {
      "type": "string",
      "description": "Unique execution identifier",
      "pattern": "^exec-[a-zA-Z0-9]{12}$",
      "example": "exec-abc123def456"
    },
    "plan_id": {
      "type": "string",
      "description": "Associated plan identifier",
      "pattern": "^plan-[a-zA-Z0-9]{12}$",
      "example": "plan-xyz789abc123"
    },
    "workflow_id": {
      "type": "string",
      "description": "Workflow definition identifier",
      "example": "debug_test_failure"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "in_progress", "completed", "failed", "cancelled"],
      "description": "Current execution status"
    },
    "current_task": {
      "type": "integer",
      "description": "Current task number (1-indexed)",
      "minimum": 1
    },
    "total_tasks": {
      "type": "integer",
      "description": "Total number of tasks in plan",
      "minimum": 1
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when execution started"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last update"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when execution completed"
    },
    "duration_ms": {
      "type": "integer",
      "description": "Total execution time in milliseconds",
      "minimum": 0
    },
    "tasks_completed": {
      "type": "array",
      "description": "List of completed tasks",
      "items": {
        "type": "object",
        "required": ["task_id", "status", "duration_ms"],
        "properties": {
          "task_id": {
            "type": "integer",
            "description": "Task number",
            "minimum": 1
          },
          "status": {
            "type": "string",
            "enum": ["success", "failure", "skipped"],
            "description": "Task completion status"
          },
          "duration_ms": {
            "type": "integer",
            "description": "Task execution time in milliseconds",
            "minimum": 0
          },
          "tool_calls": {
            "type": "integer",
            "description": "Number of tool calls made",
            "minimum": 0
          },
          "retries": {
            "type": "integer",
            "description": "Number of retry attempts",
            "minimum": 0
          },
          "result": {
            "type": "object",
            "description": "Task execution result",
            "properties": {
              "output": {
                "type": "string",
                "description": "Task output"
              },
              "error": {
                "type": "string",
                "description": "Error message if failed"
              }
            }
          },
          "started_at": {
            "type": "string",
            "format": "date-time"
          },
          "completed_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "current_task_state": {
      "type": "object",
      "description": "State of currently executing task",
      "properties": {
        "task_id": {
          "type": "integer",
          "minimum": 1
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "attempts": {
          "type": "integer",
          "description": "Current attempt number",
          "minimum": 1
        },
        "status": {
          "type": "string",
          "enum": ["running", "waiting", "retrying"]
        },
        "tool_calls_made": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "context": {
      "type": "object",
      "description": "Execution context and metadata",
      "properties": {
        "user_query": {
          "type": "string",
          "description": "Original user query"
        },
        "workspace_path": {
          "type": "string",
          "description": "Workspace root path"
        },
        "llm_config": {
          "type": "object",
          "properties": {
            "planning_model": {
              "type": "string"
            },
            "execution_model": {
              "type": "string"
            }
          }
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "Execution metrics",
      "properties": {
        "total_llm_calls": {
          "type": "integer",
          "description": "Total LLM API calls",
          "minimum": 0
        },
        "total_tokens_used": {
          "type": "integer",
          "description": "Total tokens consumed",
          "minimum": 0
        },
        "total_cost_usd": {
          "type": "number",
          "description": "Total cost in USD",
          "minimum": 0
        },
        "tool_execution_time_ms": {
          "type": "integer",
          "description": "Time spent in tool execution",
          "minimum": 0
        },
        "llm_time_ms": {
          "type": "integer",
          "description": "Time spent in LLM calls",
          "minimum": 0
        }
      }
    },
    "errors": {
      "type": "array",
      "description": "Errors encountered during execution",
      "items": {
        "type": "object",
        "properties": {
          "task_id": {
            "type": "integer"
          },
          "error_code": {
            "type": "string"
          },
          "error_message": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "recoverable": {
            "type": "boolean"
          }
        }
      }
    },
    "checkpoints": {
      "type": "array",
      "description": "Execution checkpoints for recovery",
      "items": {
        "type": "object",
        "properties": {
          "checkpoint_id": {
            "type": "string"
          },
          "task_id": {
            "type": "integer"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "state_snapshot": {
            "type": "object"
          }
        }
      }
    },
    "output": {
      "type": "object",
      "description": "Final execution output",
      "properties": {
        "success": {
          "type": "boolean"
        },
        "result": {
          "type": "string"
        },
        "artifacts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["file", "report", "data"]
              },
              "path": {
                "type": "string"
              },
              "description": {
                "type": "string"
              }
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "execution_id": "exec-abc123def456",
      "plan_id": "plan-xyz789abc123",
      "workflow_id": "debug_test_failure",
      "status": "in_progress",
      "current_task": 3,
      "total_tasks": 7,
      "created_at": "2025-01-15T10:00:00Z",
      "updated_at": "2025-01-15T10:05:00Z",
      "duration_ms": 300000,
      "tasks_completed": [
        {
          "task_id": 1,
          "status": "success",
          "duration_ms": 245,
          "tool_calls": 1,
          "retries": 0,
          "result": {
            "output": "Test file read successfully"
          },
          "started_at": "2025-01-15T10:00:00Z",
          "completed_at": "2025-01-15T10:00:01Z"
        },
        {
          "task_id": 2,
          "status": "success",
          "duration_ms": 1023,
          "tool_calls": 2,
          "retries": 0,
          "result": {
            "output": "Test executed, found failure"
          },
          "started_at": "2025-01-15T10:00:01Z",
          "completed_at": "2025-01-15T10:00:03Z"
        }
      ],
      "current_task_state": {
        "task_id": 3,
        "started_at": "2025-01-15T10:00:05Z",
        "attempts": 1,
        "status": "running",
        "tool_calls_made": 1
      },
      "context": {
        "user_query": "Fix the failing test_user_login test",
        "workspace_path": "/workspace/myproject",
        "llm_config": {
          "planning_model": "gpt-4",
          "execution_model": "gpt-4"
        }
      },
      "metrics": {
        "total_llm_calls": 5,
        "total_tokens_used": 2500,
        "total_cost_usd": 0.05,
        "tool_execution_time_ms": 1268,
        "llm_time_ms": 3000
      },
      "errors": [],
      "checkpoints": [
        {
          "checkpoint_id": "chk-001",
          "task_id": 2,
          "timestamp": "2025-01-15T10:00:03Z"
        }
      ]
    }
  ]
}
