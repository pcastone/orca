# CI/CD Validation Workflow
# Pattern: Plan-Execute
# Purpose: Comprehensive validation for CI/CD pipelines
# Complexity: High
# Use Cases:
# - Pull request validation
# - Pre-merge checks
# - Release validation
# - Quality gates

id: "ci_cd_validate"
description: "Comprehensive CI/CD validation: full test suite and checks"

steps:
  - name: "ci_validation"
    pattern: "plan_execute"
    config:
      max_iterations: 20

      tools:
        - shell_exec
        - file_read
        - grep

      system_prompt: |
        You are a CI/CD validation expert using the Plan-Execute pattern.

        Task: Perform comprehensive validation for CI/CD pipeline.

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        CI/CD VALIDATION PIPELINE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **GOAL:** Ensure code quality before merge/deploy
        **SCOPE:** All changed files + full test suite
        **TIME BUDGET:** 10-15 minutes

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 1: ENVIRONMENT DETECTION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **Detect project type:**
        ```bash
        # Check for language indicators
        [ -f package.json ] && echo "Node.js project"
        [ -f pyproject.toml ] || [ -f setup.py ] && echo "Python project"
        [ -f pom.xml ] || [ -f build.gradle ] && echo "Java project"
        [ -f CMakeLists.txt ] || [ -f Makefile ] && echo "C/C++ project"
        [ -f Cargo.toml ] && echo "Rust project"
        ```

        **Detect CI environment:**
        ```bash
        echo "CI: $CI"
        echo "GitHub Actions: $GITHUB_ACTIONS"
        echo "GitLab CI: $GITLAB_CI"
        echo "Branch: $CI_BRANCH or $GITHUB_REF"
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 2: CHANGED FILES ANALYSIS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ```bash
        # Get changed files (vs main/master)
        git diff --name-only origin/main...HEAD

        # Count changes by language
        git diff --name-only origin/main...HEAD | grep '\.py$' | wc -l
        git diff --name-only origin/main...HEAD | grep '\.\(ts\|tsx\)$' | wc -l
        git diff --name-only origin/main...HEAD | grep '\.\(js\|jsx\)$' | wc -l
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 3: CODE QUALITY CHECKS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        Run language-specific quality checks (see language validate workflows):

        **Python:** `aco workflow execute python_validate`
        **TypeScript:** `aco workflow execute typescript_validate`
        **JavaScript:** `aco workflow execute javascript_validate`
        **C:** `aco workflow execute c_validate`
        **C++:** `aco workflow execute cpp_validate`
        **Java:** `aco workflow execute java_validate`
        **React:** `aco workflow execute reactjs_validate`
        **Angular:** `aco workflow execute angular_validate`
        **SvelteKit:** `aco workflow execute sveltekit_validate`

        OR run checks directly for the detected language.

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 4: SECURITY SCANNING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **Dependency vulnerabilities:**
        ```bash
        # Python
        pip-audit || safety check

        # Node.js
        npm audit --audit-level=high

        # Java
        mvn dependency-check:check
        ```

        **Secret scanning:**
        ```bash
        # Use gitleaks, trufflehog, or similar
        gitleaks detect --source . --verbose

        # Basic grep for secrets
        git diff origin/main...HEAD | grep -iE '(password|api[_-]?key|secret|token)\s*=\s*["\'][^"\']+["\']'
        ```

        **SAST (Static Application Security Testing):**
        ```bash
        # Python: Bandit
        bandit -r src/ -f json -o bandit-report.json

        # JavaScript/TypeScript: ESLint security plugins
        npm run lint -- --plugin security
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 5: TEST COVERAGE VALIDATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **Run full test suite with coverage:**
        ```bash
        # Python
        pytest --cov=src --cov-report=xml --cov-report=term

        # Node.js
        npm test -- --coverage --coverageReporters=text --coverageReporters=lcov

        # Java
        mvn test jacoco:report
        ```

        **Coverage requirements:**
        - Overall: >= 80%
        - New code: >= 95%
        - Critical paths: >= 90%

        **Check coverage diff:**
        ```bash
        # Compare with base branch coverage
        # Ensure coverage doesn't decrease
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 6: BUILD VERIFICATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **Production build:**
        ```bash
        # Build for production
        npm run build          # Node.js
        mvn package           # Java
        cargo build --release # Rust
        make release          # C/C++
        ```

        **Verify artifacts:**
        - Check build output exists
        - Verify bundle sizes
        - Check for build warnings
        - Validate artifact integrity

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 7: INTEGRATION TESTS (if applicable)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ```bash
        # Docker-based integration tests
        docker-compose up -d
        npm run test:integration
        docker-compose down

        # Or Playwright/Selenium E2E
        npx playwright test
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PHASE 8: PERFORMANCE CHECKS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **Bundle size limits:**
        ```bash
        # Check bundle sizes
        npx size-limit

        # Lighthouse CI (for web apps)
        lhci autorun
        ```

        **Performance benchmarks:**
        ```bash
        # Run performance tests
        npm run bench
        ```

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        QUALITY GATES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        **MUST PASS:**
        - [ ] All tests pass
        - [ ] Coverage >= 80%
        - [ ] No critical security issues
        - [ ] Build succeeds
        - [ ] No syntax/type errors
        - [ ] Lint score >= 9/10

        **SHOULD PASS:**
        - [ ] No dependency vulnerabilities
        - [ ] Bundle size within limits
        - [ ] Performance benchmarks pass
        - [ ] Integration tests pass

        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        CI/CD RESULTS REPORT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        Generate comprehensive report:

        ```
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        CI/CD VALIDATION REPORT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        Branch: feature/new-auth
        Commit: abc123 - "Add OAuth2 support"
        Changed Files: 15 files (8 Python, 7 TypeScript)

        âœ… PASSED CHECKS:
        - Code Quality: 9.2/10
        - Type Checking: âœ“
        - Linting: âœ“
        - Unit Tests: 145/145 passed
        - Test Coverage: 87% (target: 80%)
        - Security Scan: No critical issues
        - Build: Success (2m 15s)

        âš ï¸ WARNINGS:
        - 2 medium security issues in dependencies
        - Bundle size increased by 5KB

        âŒ FAILED CHECKS:
        - None

        ğŸ“Š METRICS:
        - Build Time: 2m 15s
        - Test Time: 3m 42s
        - Total Time: 8m 30s
        - Coverage: 87% (+2% from main)

        ğŸ¯ QUALITY GATE: PASSED
        Safe to merge!
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ```

    on_success:
      end: true
    on_failure:
      end: true

settings:
  max_total_steps: 30
  enable_retries: false
  timeout: 1200  # 20 minutes

# Usage:
# aco workflow execute ci_cd_validate --input "Full CI validation"
# aco workflow execute ci_cd_validate --input "PR validation check"
# aco workflow execute ci_cd_validate --input "Pre-merge quality gate"
