# Add Feature Workflow
# Pattern: Plan-Execute (Planning before execution)
# Purpose: Implement a new feature from scratch
# Complexity: Very High
# Use Cases:
# - Implement new functionality
# - Add new modules or components
# - Create new API endpoints
# - Implement complex algorithms
# - Add database migrations and models

id: "add_feature"
description: "Implement a new feature systematically (Understand -> Plan -> Implement -> Verify)"

steps:
  - name: "implement_feature"
    pattern: "plan_execute_1"
    config:
      # Feature implementation is complex, allow many steps
      max_steps: 20

      # Enable replanning if discovery changes the approach
      replanning_enabled: true

      # Comprehensive toolset for implementation
      tools:
        - file_read
        - file_write
        - file_patch
        - grep
        - fs_list
        - shell_exec
        - git_status
        - git_add
        - git_diff

      # System prompt for the planner
      planner_config:
        temperature: 0.7
        system_prompt: |
          You are a senior software engineer creating a plan to implement a new feature.

          Task: Create a detailed, step-by-step plan to implement the requested feature.

          Planning Strategy:
          1. UNDERSTAND:
             - Read relevant existing code and module structure
             - Search for similar features/patterns to follow (search_code)
             - Understand dependencies

          2. CREATE:
             - Create new files/modules (write_file)
             - Define data structures and interfaces

          3. IMPLEMENT:
             - Implement core logic
             - Update existing files to integrate new feature (edit_file)
             - Add exports/mod.rs updates

          4. VERIFY:
             - Create tests for new feature (write_file)
             - Run tests (run_test)
             - Fix any compilation errors (run_build)

          5. FINALIZE:
             - Format code
             - Document the feature
             - Stage changes (git_add)

          Use the available actions:
          - read_file, write_file, edit_file, list_files
          - grep (or search_code)
          - run_test, run_build (via shell_exec)
          - git_status, git_add

      # System prompt for the executor
      executor_config:
        temperature: 0.5
        system_prompt: |
          You are a skilled developer executing a plan to implement a new feature.

          For each step:
          1. Execute the necessary tools (file_write, file_patch, shell_exec, etc.)
          2. Verify the output
          3. Report progress clearly

          Implementation Guidelines:
          - Follow existing code style and patterns
          - Use file_patch for small edits, file_write for new files
          - Always run tests after implementation
          - If build fails, fix it immediately
          - Write clear documentation/comments

    on_success:
      end: true

    on_failure: "fallback_implementation"

  # Fallback: Reactive mode if planning fails
  - name: "fallback_implementation"
    pattern: "react_1"
    config:
      max_iterations: 15
      tools:
        - file_read
        - file_write
        - file_patch
        - grep
        - fs_list
        - shell_exec
        - git_status
        - git_add
        - git_diff

      system_prompt: |
        The planned implementation encountered issues. Switch to reactive mode.

        Goal: Complete the feature implementation.

        1. Check current state (git_status, file contents)
        2. Fix any errors or missing parts
        3. Verify with tests
        4. Finish implementation

    on_success:
      end: true

    on_failure:
      end: true

# Settings for feature implementation
settings:
  max_total_steps: 30
  enable_retries: true
  max_retries: 2
  timeout: 1200  # 20 minutes for full feature implementation

# Usage Examples:
# aco workflow execute add_feature --input "Add user authentication middleware"
# aco workflow execute add_feature --input "Implement new REST API for products"
# aco workflow execute add_feature --input "Create a background job processor"

